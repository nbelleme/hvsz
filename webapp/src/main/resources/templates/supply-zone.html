<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Zone de sécurité</title>
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css"
          media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
<div th:include="menu"/>
<section class="container">
    <h1 th:text="${zone.name}"></h1>
    <div th:if="${message}" class="card">
        <div class="card-content red lighten-2 darken-1">
            <p class="white-text"><span th:text="${message}"></span></p>
        </div>
    </div>
    <div class="card">
        <div class="card-content brown darken-1">
            <p class="white-text">Il reste <span th:text="${zone.resource}"></span> ressource(s) dans la zone de
                sécurité et vous pouvez porter <span th:text="${maxResource}"></span> ressources maximum.</p>
        </div>
    </div>
    <div th:if="${nbTaken}" class="card">
        <div class="card-content teal darken-1">
            <p class="white-text"><span th:text="${nbTaken}"></span> ressource(s) prise(s)</p>
        </div>
    </div>
    <form method="post" action="/resource/get">
        <fieldset class="row">
            <legend>Prendre une ressource</legend>
            <input type="hidden" name="zoneId" th:value="${zone.id}"/>
            <input type="hidden" name="nbResWanted" id="nbResWanted" value="1"/>
            <div class="input-field col s12">
                <label for="lifeToken">Votre code utilisateur</label>
                <input type="text" name="lifeToken" id="lifeToken" required="required" />
            </div>
            <button class="btn waves-effect waves-light" type="submit"
                    name="action" id="take-button">Prendre (maintenir appuyé)
            </button>
        </fieldset>
    </form>
</section>
<footer>
</footer>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"/>
<script th:inline="javascript">
    $(function () {
        var text = "Prendre (maintenir appuyé)";
        var defaultNb = 0;
        var nb = 0;
        var increase = false;
        var defaultMaxRes = [[${maxResource}]]; //default max resource
        var maxRes = defaultMaxRes;
        var token = null;

        function increaseLoop(cb) {
            var loop = setInterval(function () {
                if (!increase || nb >= maxRes) {
                    clearInterval(loop);
                    return;
                }
                nb++; //Increase the counter
                cb(); //Call the callback
            }, 1000);
        }

        /**
         * Utils
         */
        function reset() {
            increase = false;
            $("#take-button").text(text);
            $("#nbResWanted").val(nb);
            nb = defaultNb;
        }

        function getNbResource(callback) {
            var token = $("#lifeToken").val();
            $.getJSON("/api/game/1/life/" + token + "/nbResource", function (nbResource) {
                maxRes = defaultMaxRes - nbResource;
                console.log("OK");
                callback();
            }, function(err) { console.log(err); });
        }

        /**
         * Button
         */
        function onMouseDown(e) {
            getNbResource(function () {
                e.preventDefault();
                increase = true;
                increaseLoop(function () {
                    $("#take-button").text('Prendre ' + nb + ' ressources');
                });
            });
        }

        function onMouseUp(e) {
            reset();
            $("form").submit();
        }

        function onMouseLeave(e) {
            reset();
        }

        //Events
        $("#take-button").mousedown(onMouseDown);
        $("#take-button").mouseup(onMouseUp);
        $("#take-button").mouseout(onMouseLeave);
        $("#take-button").mouseleave(onMouseLeave);
    });
</script>
</body>
</html>